---
title: "面经 百姓网 Go开发"
date: 2021-09-16T21:55:46+08:00
draft: true
tags: ["面试"]
---

来扇贝后第一次出去面试，其实没啥准备，基本相当于裸面了，一是想检验一下自己的积累看看自己现在到了什么水平了，二是顺便看看有没有合适的机会，整场面试 50min 左右，难度适中，但不得不吐槽一下腾讯会议太烂了，前 30min 断断续续的...
<!--more-->
## 进入正题
1> 介绍一下在扇贝的工作，觉得这一年最大的进步是什么

一堆巴拉巴拉的，介绍了一下做的项目，负责的工作

2> 哪个项目最有难度

介绍了一下简历上写的几个项目：
1. 学习中台的重构，介绍了一下重构的上线的难点，包括镜像流量做 diff，灰度上线，重点和面试官讨论了一下灰度前镜像流量 diff 的方案
2. 网关的 Service mesh 服务，做了路由自动发现功能，还有 k8s 灰度发布的 operator
3. UGC 审核中台从零到一的开发，架构设计上 rpc 提审、消息队列异步送审、RabbitMQ 出结果通知下游，冷热数据分表，热数据定期归档，冷数据根据用户分库分表等等

后面就是根据这几个项目发散问了一些点：

3> 为什么使用 RabbitMQ 做中间件

主要还是因为之前技术栈是 Python，一直在用 Celery 做消息队列，是基于标准的 amqp 协议做的，所以 RabbitMQ 肯定是首选，后面迁移到 Go 后也保留了下来，目前看来对于扇贝的体量来说 RabbitMQ 是完全够用的

4> 怎么保证送审的内容不丢失的

面试官应该是想问用 RabbitMQ 是怎么保证消息不丢失的，不过一开始我只是从业务层面讲了一个点：
1. 作为消息的生产者，要保重不丢失，首先在业务层面提交的内容我们就会给它分配一个事物 id，保证先落库再送发到消息队列，这样即使 mq 出问题，或者内容没有发到审核服务商，这部分数据都是可以捞出来重新审核的

后来有问在消息队列本身是否有做处理，这下才明白要问的点，然后进行了补充：

2. 开启了 confirm 模式，根据是否 ack 做重试，至多进行三次重试
3. 在 mq 层面，用了镜像队列的模式部署，不过我对部署细节不熟，因为毕竟部署不是自己负责的
4. 在消费者方面，消费完了 ack，并且会根据业务的唯一索引的字段保证消费幂等

5> 系统设计题，怎么做秒杀系统？怎么防止超卖

没做过秒杀系统，也没背过八股文，于是根据在扇贝评审四六级查分（类似秒杀的场景，短时间大量用户过来进行查分）技术方案的经验讲了一下大概设计：

1. 请求过来放进消息队列削峰处理，防止 db 一下被打挂
2. 事前尽可能通过一些运营活动进行分流，让一部分用户进行预订，系统开放时分流一部分单独处理
3. 限流，我们用的是 envoy 的 ratelimit 插件在网关层面做的
4. 加锁处理，分布式的 redis 锁，加上 block_timeout 参数让它自旋，本质上是将操作串行来保护库存量

当然了，我回答的时候默认是在微服务架构模式下的，所以像服务隔离故障隔离这种点就没有答

后面上网查了下，其实除此之外还有很多没考虑的点，感兴趣可以看下知乎的这个问题:[如何做秒杀系统](https://www.zhihu.com/question/54895548)，比如:

1. 加验证码防爬虫
2. 服务熔断 
3. 缓存预热
4. 库存数据先加载到 redis，秒杀的所有操作先直接写 redis 再异步落库（其实扇贝的学习主流程也是这么做的，可惜当时没能联想到）

6> 既然提到 redis 锁，那讲讲 redis 锁的实现？

答了 `setnx` + `expire`，不过应该不是面试官想问的，这题也是经典老八股文了，不过还是因为我几乎零准备，所以更细节的没有答上来，感兴趣可以去看看 redlock 实现

7> redis 跳跃表的实现，为什么用跳表

大概答了是一个多层的链表结构，然后二分的去下层查找，之所以用跳表一是查询效率高，二是实现起来比树结构简单。这题答的内容不多，正好也是一个需要查漏补缺的点。

8> mysql 有个聚簇索引和非聚簇索引的概念有了解吗？

这个算是基础不牢了，没有注意过这几个名词，于是把话题引到了联合索引上面

9> 场景题，联合索引的命中规则

就根据最左前缀规则去答的

10> 知道回表的概念吗？怎么避免频繁回表

因为 mysql b+ 树索引叶子节点存的数据是主键 id，所以如果不额外处理，每次查出来主键 id 之后都要根据这些 id 去表里走主键索引查出完整数据，想避免的话可以把经常查询的字段做成联合索引，这样叶子结点本身就存了要查的字段，可以避免回表，这应该是覆盖索引的概念，好在之前还是学过的

11> 一道算法题，扔鸡蛋问题

这题给我只能给出暴力和二分的方法，其实很久以前在蓝桥杯省赛遇到过，没做出来，当时还特地去补了，结果现在又忘了，看来算法题还是不练不行，leetcode 原题，感兴趣看看吧:

1. https://leetcode-cn.com/problems/egg-drop-with-2-eggs-and-n-floors/
2. https://leetcode-cn.com/problems/super-egg-drop/

12> 了解 http2 吗，大概讲讲

了解，项目用的 gRPC，底层的通信协议就是基于 http2 的，http2 对比 http1.x 对请求头做了压缩，体积更小，它的 IO 多路复用也是真正的复用，相比之下 http1.x 只是共用一个 tcp 链接，但还是串行的，http2 的复用是通过管道来做的，所以个请求包装在不同管道内共享 tcp 链接，通过请求 id 区分隔离

13> 项目用的都是微服务架构吗？用了什么框架

用的 gRPC + k8s + envoy 这一套

14> 注册中心用的什么

没有传统微服务架构的注册中心，用的是偏向云原生模式的 service mesh 方案， envoy + k8s 的 informer 机制，通过 informer 和自己开发的 service mesh 服务做 service 和路由的热更新，提供 rpc 接口给网关 envoy 去读取

15> 后面就是面试收尾时的几个常规问题了，介绍下自己的优点、有什么想了解的之类的

大概问了下他们的工作流程，业务架构之类的，然后就结束面试了

