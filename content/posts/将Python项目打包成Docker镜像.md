---
title: "å°†Pythoné¡¹ç›®æ‰“åŒ…æˆDockeré•œåƒ"
date: 2020-01-31T15:36:42+08:00
draft: false
tags: ["Devops"]
---

<meta name="referrer" content="no-referrer" />
ä¹‹å‰å†™äº†ä¸€ç¯‡ Dockerfileç¼–å†™æŒ‡å—ï¼Œä¸è¿‡æ²¡æœ‰æ¶‰åŠåˆ°éƒ¨ç½²é¡¹ç›®è¿™ç§ç›¸å¯¹å¤æ‚çš„æ“ä½œï¼Œæœ€è¿‘å†™æ¯•è®¾éœ€è¦æŠŠé¡¹ç›®æ‰“åŒ…æˆdockeré•œåƒï¼Œéƒ¨ç½²åœ¨æœåŠ¡å™¨ä¸Šï¼Œå› æ­¤å†™ä¸‹è¿™ç¯‡åšå®¢ï¼Œå¯¹ä¸Šé¢é‚£ç¯‡åšä¸€ä¸ªè¡¥å……å¼•ç”³ã€‚

ä¸€ä¸ªå°†Pythoné¡¹ç›®æ‰“åŒ…æˆdockeré•œåƒçš„åŸºæœ¬æµç¨‹å¦‚ä¸‹:
> ç¼–å†™å¥½Dockerfileä¸Šä¼ è‡³Github/Gitlab -> gitæ‹‰å–ä»£ç åˆ°æœåŠ¡å™¨ -> buildé•œåƒ
> -> docker runé…ç½®ç«¯å£æ˜ å°„ -> è®¾ç½®æœåŠ¡å™¨å®‰å…¨ç»„

<!--more-->

é˜…è¯»æœ¬æ–‡ï¼Œå¤§æ¦‚éœ€è¦ä½ æŒæ¡gitå’Œdockerçš„åŸºæœ¬ç”¨æ³•ã€‚
> ps: æœ¬æ–‡é»˜è®¤ä½ çš„æœºå™¨å·²ç»è£…å¥½å¹¶é…ç½®å¥½gitï¼Œå¦‚ä½•å®‰è£…ï¼ŸğŸ‘‡
> [èœé¸Ÿæ•™ç¨‹](https://www.runoob.com/git/git-install-setup.html)


## ç¼–å†™é¡¹ç›®æ‰€éœ€çš„Dockerfile
- å°†é¡¹ç›®æ‰“åŒ…æˆé•œåƒçš„Dockerfileä¸€èˆ¬æ”¾åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹ï¼Œè¿™æ ·æ–¹ä¾¿åé¢è®¾ç½®é•œåƒçš„å·¥ä½œç›®å½•ç­‰ã€‚

1. åŸºç¡€é•œåƒä»¥åŠç»´æŠ¤è€…ä¿¡æ¯
  ä¸€ä¸ªpythoné¡¹ç›®çš„ç‰ˆæœ¬æ˜¯å¾ˆé‡è¦çš„ï¼Œå› ä¸ºä»2åˆ°3 (è¿™ä¸ªå°±ä¸ç”¨å¤šè¯´äº†)ï¼Œ3.4å‘åçš„ç‰ˆæœ¬ (3.5çš„åç¨‹å¼•å…¥äº†`async/await`å…³é”®å­—)ä¼šæœ‰ä¸€äº›ä¸å…¼å®¹çš„åœ°æ–¹ï¼Œæ‰€ä»¥è®¾ç½®åŸºç¡€é•œåƒä¹‹å‰è¯·å…ˆæŸ¥çœ‹é¡¹ç›®ç”¨çš„pythonç‰ˆæœ¬ï¼Œä»¥é˜²ä¸å¿…è¦çš„éº»çƒ¦ã€‚
  è¿™é‡Œæˆ‘ç”¨çš„æ˜¯Python 3.6,3ï¼Œæ‰€ä»¥ï¼š
  ```dockerfile
  # ä»¥Python3.6.3ä½œä¸ºåŸºç¡€é•œåƒ
  FROM python:3.6.3

  # ç»´æŠ¤è€…
  MAINTAINER mambahj24@gmail.com
  ```
2. æŠŠé¡¹ç›®ä»£ç æ·»åŠ åˆ°é•œåƒä¸­
  éƒ¨ç½²é¡¹ç›®å’Œä¹‹å‰çš„Dockerfileæœ‰ä¸€ä¸ªä¸åŒç‚¹å°±æ˜¯éœ€è¦æŠŠè‡ªå·±çš„ä»£ç æ”¾åˆ°é•œåƒä¸­ï¼Œè¿™é‡Œå°±è¦å¼•å…¥ä¸¤ä¸ªä¹‹å‰æ²¡è®²çš„å…³é”®å­—ADDï¼ŒWORKDIRï¼š
  - ä½¿ç”¨ADDï¼Œå¯ä»¥æŠŠæœ¬åœ°æ–‡ä»¶æ·»åŠ åˆ°å®¹å™¨ä¸­
  - WORKDIRï¼Œç±»ä¼¼äºcdå‘½ä»¤ï¼Œå°±æ˜¯å°†è¿™ä¸ªç›®å½•è®¾ç½®ä¸ºé•œåƒçš„å·¥ä½œç›®å½•

  å‡è®¾ä½ çš„é¡¹ç›®æ ¹ç›®å½•æ˜¯`/proj`ï¼Œæˆ‘ä»¬ä¸€èˆ¬éœ€è¦è®¾ç½®è¿™ä¸¤æ­¥:
  ```dockerfile
  # å°†é¡¹ç›®æ–‡ä»¶æ·»åŠ åˆ°é•œåƒå†…çš„spideræ–‡ä»¶å¤¹
  ADD . /proj

  # è®¾ç½®spiderç›®å½•ä¸ºå·¥ä½œç›®å½•,ç›¸å½“äºcd
  WORKDIR /proj
  ```
  **.ä»£è¡¨å½“å‰ç›®å½•ï¼Œä¹Ÿå°±æ˜¯Dockerfileæ‰€åœ¨çš„ç›®å½•ã€‚**

3. è®¾ç½®ç¯å¢ƒå˜é‡ã€ç«¯å£
  ä¸€èˆ¬é¡¹ç›®é‡Œè‚¯å®šæ˜¯è¦æœ‰ç¯å¢ƒå˜é‡è¿˜è¦è®¾ç½®ç«¯å£å·çš„ï¼Œè¿™ä¸¤ä¸ªå°±ä¸å¤šè¯´äº†ï¼š
  ```dockerfile
  ENV var val

  EXPOSE ç«¯å£å·
  ```
4. å®‰è£…ç¯å¢ƒä¾èµ–å’Œé¡¹ç›®ä¾èµ–
  ä¸¾ä¸ªä¾‹å­ï¼Œæˆ‘è¦åœ¨é•œåƒä¸­å®‰è£…å¥½vimå’Œlsofï¼Œå¹¶ä¸”å®‰è£…å¥½é¡¹ç›®çš„ä¾èµ–requirements.txtæ–‡ä»¶ï¼Œæœ€å¥½è¿˜è¦æœ‰é˜¿é‡Œäº‘çš„é•œåƒåŠ é€Ÿï¼Œè¿™åº”è¯¥æ˜¯ä¸€ä¸ªpythoné¡¹ç›®éƒ¨ç½²å¾ˆå¸¸è§çš„åœºæ™¯äº†:

  ```dockerfile
  # buildé•œåƒæ—¶è¿è¡Œçš„å‘½ä»¤ï¼Œå®‰è£…vimï¼Œä»¥åŠé¡¹ç›®ä¾èµ–
  RUN apt-get update && apt-get install vim -y \
      && apt-get install lsof -y && apt-get clean \
      && pip install -r requirements.txt -i https://mirrors.aliyun.com/pypi/simple/
  ```

5. æœ€åä¹Ÿæ˜¯æœ€é‡è¦çš„ï¼Œ`docker run`æ„å»ºå®¹å™¨æ—¶é»˜è®¤æ‰§è¡Œçš„å‘½ä»¤
  å‰é¢å·²ç»è¯´è¿‡ï¼Œè¦ç”¨CMDï¼Œæˆ‘ä»¬éœ€è¦åœ¨å¼€å¯å®¹å™¨æ—¶æ›¿æˆ‘ä»¬è¿è¡Œå¥½å¯åŠ¨é¡¹ç›®çš„å‘½ä»¤ã€‚
  ä¸è¿‡CMDæœ‰ä¸€ä¸ªå±€é™å°±æ˜¯ï¼Œä¸€ä¸ªDockerfileä¸­åªæœ‰æœ€åä¸€ä¸ªCMDæ‰ä¼šç”Ÿæ•ˆï¼Œæ‰€ä»¥ï¼Œå¦‚æœä½ çš„é¡¹ç›®å¯åŠ¨æ—¶éœ€è¦å¯åŠ¨å¾ˆå¤šä¸ªå‘½ä»¤ï¼Œæˆ‘çš„å»ºè®®æ˜¯å†™ä¸€ä¸ªshellè„šæœ¬ï¼ŒæŠŠå‘½ä»¤æ”¾è¿›å»ï¼Œç„¶ååœ¨CMDä¸­ç”¨`["sh", "xxx.sh"]`æ¥æ‰§è¡Œã€‚

  è¿™é‡Œå°±ä¸å¾—ä¸æå®¹å™¨ä¸­åº”ç”¨åœ¨å‰å°æ‰§è¡Œå’Œåå°æ‰§è¡Œçš„é—®é¢˜ã€‚è¿™æ˜¯åˆå­¦è€…å¸¸å‡ºç°çš„ä¸€ä¸ªæ··æ·†ã€‚

  ä»¥ä¸‹å¼•ç”¨ä¸€æ®µdockerçš„æ–‡æ¡£ï¼š

  > Docker ä¸æ˜¯è™šæ‹Ÿæœºï¼Œå®¹å™¨ä¸­çš„åº”ç”¨éƒ½åº”è¯¥ä»¥å‰å°æ‰§è¡Œï¼Œè€Œä¸æ˜¯åƒè™šæ‹Ÿæœºã€ç‰©ç†æœºé‡Œé¢é‚£æ ·ï¼Œç”¨ systemd å»å¯åŠ¨åå°æœåŠ¡ï¼Œå®¹å™¨å†…æ²¡æœ‰åå°æœåŠ¡çš„æ¦‚å¿µã€‚
  > ä¸€äº›åˆå­¦è€…å°† CMD å†™ä¸ºï¼š
  > `CMD service nginx start`
  > ç„¶åå‘ç°å®¹å™¨æ‰§è¡Œåå°±ç«‹å³é€€å‡ºäº†ã€‚ç”šè‡³åœ¨å®¹å™¨å†…å»ä½¿ç”¨ systemctl å‘½ä»¤ç»“æœå´å‘ç°æ ¹æœ¬æ‰§è¡Œä¸äº†ã€‚è¿™å°±æ˜¯å› ä¸ºæ²¡æœ‰ææ˜ç™½å‰å°ã€åå°çš„æ¦‚å¿µï¼Œæ²¡æœ‰åŒºåˆ†å®¹å™¨å’Œè™šæ‹Ÿæœºçš„å·®å¼‚ï¼Œä¾æ—§åœ¨ä»¥ä¼ ç»Ÿè™šæ‹Ÿæœºçš„è§’åº¦å»ç†è§£å®¹å™¨ã€‚
  > å¯¹äºå®¹å™¨è€Œè¨€ï¼Œå…¶å¯åŠ¨ç¨‹åºå°±æ˜¯å®¹å™¨åº”ç”¨è¿›ç¨‹ï¼Œå®¹å™¨å°±æ˜¯ä¸ºäº†ä¸»è¿›ç¨‹è€Œå­˜åœ¨çš„ï¼Œä¸»è¿›ç¨‹é€€å‡ºï¼Œå®¹å™¨å°±å¤±å»äº†å­˜åœ¨çš„æ„ä¹‰ï¼Œä»è€Œé€€å‡ºï¼Œå…¶å®ƒè¾…åŠ©è¿›ç¨‹ä¸æ˜¯å®ƒéœ€è¦å…³å¿ƒçš„ä¸œè¥¿ã€‚

  æˆ‘æ¥è§£é‡Šä¸€ä¸‹ï¼Œä½¿ç”¨serviceå°±æ˜¯è¦ä»¥å®ˆæŠ¤è¿›ç¨‹åœ¨åå°æ‰§è¡Œç¨‹åºï¼Œç±»ä¼¼çš„è¿˜æœ‰nohupå‘½ä»¤ï¼Œä½†æ˜¯`CMD service nginx start`å…¶å®åœ¨dockerä¸­æ˜¯è¢«è¿™æ ·æ‰§è¡Œçš„ï¼š

  ```dockerfile
  CMD ["sh", "-c", "service nginx start"]
  ```
  ä¸»è¿›ç¨‹å…¶å®æ˜¯shï¼Œå½“`service nginx start`ç»“æŸäº†ä¹‹åï¼Œshä½œä¸ºä¸»è¿›ç¨‹é€€å‡ºï¼Œå®¹å™¨ä¹Ÿä¼šè·Ÿç€é€€å‡ºã€‚æ‰€ä»¥ä½¿ç”¨CMDå‘½ä»¤æœ€ä¸»è¦çš„ä¸€ç‚¹å°±æ˜¯è¦è®©å®¹å™¨ä¸­çš„åº”ç”¨åœ¨å‰å°æ‰§è¡Œï¼Œæ€»ä¹‹ï¼Œä¸èƒ½è®©ä¸»è¿›ç¨‹é€€å‡ºã€‚

  æ‰€ä»¥ï¼Œæ‰§è¡Œå¤šä¸ªå‘½ä»¤æ—¶ï¼Œè¿™äº›å‘½ä»¤æœ€å¥½éƒ½è¦ç›´æ¥åœ¨å‰å°è¿è¡Œï¼Œä½†å¦‚æœå‡ ä¸ªå‘½ä»¤éƒ½æ˜¯é˜»å¡å¼çš„ï¼š
  æ¯”å¦‚ä¸€ä¸ªæ˜¯`django runserver`ä¸€ä¸ªæ˜¯celeryå¯ç”¨workerï¼Œåœ¨ä¸ç”¨dockeræ—¶å¥½åŠï¼Œç›´æ¥nohupæˆ–è€…å…¶ä»–æ–¹å¼æ‰”åˆ°åå°æ‰§è¡Œï¼Œäº’ä¸å¹²æ‰°ã€‚
  ä½†åœ¨æ„å»ºå®¹å™¨æ—¶ï¼Œå°±è¦è€ƒè™‘ä¸Šè¿°çš„å› ç´ ï¼Œæ—¢ä¸èƒ½å…¨éƒ¨åå°æ‰§è¡Œï¼Œä¹Ÿä¸èƒ½å…¨éƒ¨å‰å°æ‰§è¡Œï¼ˆå› ä¸ºæ˜¯é˜»å¡å¼çš„å‘½ä»¤ï¼Œåªæœ‰ä¸€ä¸ªæ‰§è¡Œå®Œæ¯•æ‰è½®åˆ°ä¸‹ä¸€ä¸ªï¼‰ï¼Œæˆ‘è®¤ä¸ºæœ€å¥½çš„æ–¹æ¡ˆå°±æ˜¯å‰é¢çš„å‘½ä»¤å…¨åå°æ‰§è¡Œï¼Œæœ€åä¸€ä¸ªå‘½ä»¤è®©å®ƒé˜»å¡å½“å‰çº¿ç¨‹ï¼Œä¸è®©ä¸»è¿›ç¨‹é€€å‡ºï¼Œè¿™æ ·å°±æ—¢èƒ½ä¿è¯æ‰€æœ‰ç›®å½•éƒ½åœ¨æ‰§è¡Œï¼Œå¹¶ä¸”dockerå®¹å™¨ä¸ä¼šé€€å‡ºã€‚

  ä¸¾ä¸ªä¾‹å­ï¼Œä¸€ä¸ªå¯åŠ¨ç”¨çš„shellè„šæœ¬ï¼Œxxx.shï¼š
  ```bash
  #!bin/bash
  nohup command_a > a.log 2>&1 &
  nohup command_b > b.log 2>&1 &
  command_c
  ```

  Dockerfileä¸­åº”è¯¥è¿™æ ·å†™:
  ```dockerfile
  CMD ["sh", "xxx.sh"]
  ```
æœ€åï¼Œæ”¾ä¸€ä¸ªæ•´ä½“çš„æ¨¡æ¿:
```dockerfile
# ä»¥Python3.6.3ä½œä¸ºåŸºç¡€é•œåƒ
FROM python:3.6.3

# ç»´æŠ¤è€…
MAINTAINER mambahj24@gmail.com

# å°†é¡¹ç›®æ–‡ä»¶æ·»åŠ åˆ°é•œåƒå†…çš„æ–‡ä»¶å¤¹
ADD . /proj

# è®¾ç½®ä»£ç ç›®å½•ä¸ºå·¥ä½œç›®å½•,ç›¸å½“äºcd
WORKDIR /proj

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV var val

# å°†ç«¯å£æš´éœ²å‡ºå»
EXPOSE port

# buildé•œåƒæ—¶è¿è¡Œçš„å‘½ä»¤ï¼Œå®‰è£…vimï¼Œä»¥åŠé¡¹ç›®ä¾èµ–
RUN apt-get update && apt-get install vim -y \
    && apt-get install lsof -y && apt-get clean \
    && pip install -r requirements.txt -i https://mirrors.aliyun.com/pypi/simple/

# docker runæ„å»ºå®¹å™¨æ—¶ä¼šè¿è¡Œçš„å‘½ä»¤ï¼Œç”¨äºå¯åŠ¨æœåŠ¡
CMD ["sh", "/proj/xxx.sh"]
```

## æ„å»ºï¼Œä½¿ç”¨é•œåƒ
1. è¿›å…¥Dockerfileæ‰€åœ¨çš„ç›®å½•
2. æ„å»ºé•œåƒ: `docker build -t images:version .`
3. æ„å»ºå®¹å™¨: `docker run --name name -p outside_port:inside_port -d images:version`
4. æŸ¥çœ‹æ˜¯å¦å¼€å¯æˆåŠŸ: `docker ps -a`

æ›´è¿›ä¸€æ­¥ï¼Œè¿›å…¥å®¹å™¨ä¸­æŸ¥çœ‹ç«¯å£æ˜¯å¦å¼€æ”¾:
1. è¿›å…¥æ­£åœ¨è¿è¡Œçš„å®¹å™¨: `docker exec -it name /bin/bash`
2. æŸ¥çœ‹ç«¯å£ä½¿ç”¨æƒ…å†µ: `lsof -i:inside_port`
3. é€€å‡ºå®¹å™¨: `exit;`æ³¨æ„: execè¿›å…¥çš„å®¹å™¨ï¼Œé€€å‡ºåä¸ä¼šå…³é—­å®¹å™¨ï¼Œä½†attachä¼š

## å‚è€ƒ
1. [CMD å®¹å™¨å¯åŠ¨å‘½ä»¤](https://yeasy.gitbooks.io/docker_practice/image/dockerfile/cmd.html)
2. [Dockerfileç¼–å†™æŒ‡å—](https://hj24.github.io/2020/01/30/Dockerfile%E7%BC%96%E5%86%99%E6%8C%87%E5%8D%97/)
3. [ç®€ä¹¦-Pythoné¡¹ç›®æ‰“åŒ…æˆdockeré•œåƒ](https://www.jianshu.com/p/fe81ca1bccc6)
